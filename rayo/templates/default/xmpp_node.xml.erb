<?xml version="1.0" encoding="UTF-8"?>
<!-- Auto-generated by Chef for <%= node.name %> -->
<xmpp:xmpp-app xmlns:javaee="http://java.sun.com/xml/ns/javaee" xmlns:xmpp="http://www.voxeo.com/sipmethod/xmpp" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.voxeo.com/sipmethod/xmpp xmpp.xsd" version="1.1">
  <xmpp:servlet>
    <javaee:servlet-name>rayo</javaee:servlet-name>
    <javaee:servlet-class>com.rayo.server.SpringXmppServlet</javaee:servlet-class>
  <%if node["rayo"]["cluster"] -%>
    <javaee:init-param>
      <javaee:param-name>local-domain</javaee:param-name>
      <javaee:param-value><%= node.name %></javaee:param-value>
    </javaee:init-param>

    <javaee:init-param>
      <javaee:param-name>gateway-domain</javaee:param-name>
      <javaee:param-value><%=node["rayo"]["node"]["gateway"]%></javaee:param-value>
    </javaee:init-param>

    <javaee:init-param>
      <javaee:param-name>default-platform-id</javaee:param-name>
      <javaee:param-value>staging</javaee:param-value>
    </javaee:init-param>
  <% end -%>
    <javaee:load-on-startup>1</javaee:load-on-startup>
  </xmpp:servlet>
  <xmpp:defaultxmppapp/>
  <xmpp:serv-domains>
    <xmpp:servdomain>127.0.0.1</xmpp:servdomain>
    <xmpp:servdomain>localhost</xmpp:servdomain>
  <% node["rayo"]["node"]["domains"].each do |value|-%>
     <%= '<xmpp:servdomain>' + value + '</xmpp:servdomain>' %>
   <% end -%>
   <%= '<xmpp:servdomain>' + node.name + '</xmpp:servdomain>' %>
  <% if node["rayo"]["node"]["include_external_fqdn"] -%>
   <%= "<!-- For testing Martin asked for a way to add the external hostname to the xmpp srv domains on the node, this is that change -->" %>
   <%= "<xmpp:servdomain>#{node.name.dup.insert(node.name.index('.'),'-ext')}</xmpp:servdomain>" %>
  <% end -%>
  </xmpp:serv-domains>
  <xmpp:servlet-selection>
    <xmpp:main-servlet>rayo</xmpp:main-servlet>
  </xmpp:servlet-selection>
  <!-- the following is the main different part with SIP and HTTP descriptor -->
  <xmpp:inboundclient-login-config>
    <xmpp:SASL-configure>
      <xmpp:SASL-mechanism>
        <xmpp:auth-method>PLAIN</xmpp:auth-method>
        <xmpp:realm-name>MemoryRealm</xmpp:realm-name>
        <xmpp:NeedSecureTransport>FALSE</xmpp:NeedSecureTransport>
      </xmpp:SASL-mechanism>
    </xmpp:SASL-configure>
    <xmpp:features>
      <xmpp:resourcebinding/>
      <xmpp:session/>
    </xmpp:features>
  </xmpp:inboundclient-login-config>
  <xmpp:inbound-s2s-config>
  </xmpp:inbound-s2s-config>
  <xmpp:outbound-s2s-config>
  </xmpp:outbound-s2s-config>
  <listener>
    <listener-class>com.rayo.server.listener.RayoSessionListener</listener-class>
  </listener>
</xmpp:xmpp-app>
